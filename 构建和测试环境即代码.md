# 构建和测试环境即代码

`构建和测试环境即代码`和`基础设施即代码`，`流水线即代码`的概念相似，就是将你的代码构建和测试环境使用代码来表达，以达到**代码在本机正常工作...同时在任何地方都可以正常工作**。

## 薛定谔的测试

回想这样一个场景，当你加入一个想公司或者加入一个新项目的时候，是不是需要安装很多软件以使得新项目的服务或者测试可以在你本机运行？

假设这个新项目使用的编程语言是NodeJs，使用Mysql存储数据，那么很可能会出现如下情况，每个开发人员本机安装的软件版本都不太相同：

- 开发小A本机环境：NodeJS 8.1, MySQL 5.4
- 开发小B本机环境：NodeJS 8.1, MySQL 5.4
- 开发小C本机环境：NodeJS 9.2, MySQL 5.2
- 开发小D本机环境：NodeJS 12.4, MySQL 5.1

这就是为什么有时候你编写好的代码或者测试在你本机运行成功，但到了别人的机器上就会出问题，原因很可能是你的代码依赖了你本地开发环境的软件版本。即便你依赖的软件版本相同，依然可能会出现错误，因为你本地代码编译环境很可能会依赖于你的操作系统的某些软件。

这个问题甚至曾经在Google也非常严重。在2016的时候，Google就发现84%新的失败测试都是由于`flakiness`。什么是flakiness呢？

> 一个flaky测试就是在相同的配置的情况下这个测试可能会成功也可能会失败.

这个测试是不是很像薛定谔的猫，不运行的时候测试状态处于叠加状态，既可以是成功也可以是失败，当你运行之后才知道是成功还是失败。自动化测试重要性不必多说，但flaky测试显然令开发人员很疑惑，或者说是沮丧。产生flaky测试的原因有很多，而**不一致的测试环境**常常会导致测试的`flakiness`。

## 如何解决测试环境不一致的问题？

### 自动化一切事情

将所有手动的步骤使用脚本将其过程自动化起来使得构建和测试的步骤都是一致的。但光使用自动化脚本是不够的，它的问题在于：

- 所依赖的运行环境的操作系统不一致可能会导致一些问题。
- 端口冲突问题。
- ...

### 虚拟机

使用虚拟机（如Vagrant）可以解决只使用自动脚本所存在的问题。但是使用虚拟机是非常消耗资源的，对于运行在虚拟机里的任务的性能影响是比较大的。所以通常虚拟机并不被推荐在持续集成服务器上使用。

### 共享的测试和集成环境

我经历过一些项目，项目中只有单元测试是可以在本地运行的，而其他的测试都需要将代码部署到云环境后才会运行。这种方式有几个特别大的缺点：

- 从代码更改到在测试环境中运行的周期时间太长。
- 由于测试和集成环境是共享的，所以你对测试环境会影响会影响到其他开发人员的测试。这就好比你的测试依赖于一个全局环境，而这个其他人可以随时修改这个变量，那么你的测试状态就是不稳定的。

而且，实现持续集成的一个前提条件就是：**确保自动化测试可以在一个隔离的环境中运行**。

### Docker

使用Docker容器技术可以解决使用虚拟机所存在的问题。使用docker可以轻松解决一个容器的问题，但是现实项目中的情况是：

- 一个应用由多个容器组成。
- 一个容器会依赖于另一个容器。
- 容器的启动顺序是有依赖的。
- ...

举个栗子：Docker就像是一个独奏的音乐家，而现实项目需要的一个合奏团。

<img src="images/build-and-test-env-as-code-he-change-tuan.png" width="760"/>

### Docker + 基础设施即代码 + 工具

基础设施即代码的概念 + Docker + Docker工具（比如：Docker Compose, Batect, Dojo）, 将这些柔和到一起并运用到本地开发和测试环境中，可以给我们带来一些好处：

- 给自动化测试提供一个隔离的运行环境。
- 云环境和本地只需要安装Docker，和Git便可拉取代码并进行构建和测试。
- 由于配置以可执行代码而不是文档的形式表示，因此与应用程序一起分发和版本化配置更加容易。
- 测试一次运行成功，在不修改任何代码的情况下任何地方都可以运行成功。

## 构建和测试环境即代码工具

现在比较流行的容器编排工具有: Docker Compose, Dojo和Batect。我们在项目中选择使用了Batect，Batect的全名是：**B**uild **A**nd **T**est **E**nvironment as **C**ode **T**ools。选择它的原因是：

- 执行速度比Docker Compose快17%。主要是对Mac Docker和Window Docker的优化。
- 提供了development task的一种概念。
- 非常便于将你的development task配置分享给其他的项目。
- 提供了一种简单的方式可以帮助开发者发现当前项目都有哪些可以使用的task.
- 无需安装。

### Batect 示例

假设我们已经建立了一个国际转账服务(international transfer service)，该服务依赖于另一个团队维护的汇率服务(Exchange Rate Service)，并且国际转账服务拥有自己的数据存储区来跟踪客户的转账。如果要端到端测试，我们需要四个组件：

- 国际转账服务。
- 真实或伪造的汇率服务。
- 真实或伪造的数据存储。
- 某种测试驱动程序。

<img src="images/build-and-test-env-as-code-international-transfer-service.png" width="760"/>

如何使用Batect作为构建和测试环境即代码工具呢？完整代码可以到[Github](https://github.com/batect/batect-sample-java)代码库中查看。

这里我们主要看看Batect的配置文件：batect.yml

```
project_name: international-transfers-service

containers:
  database:
    build_directory: .batect/database
    environment:
      POSTGRES_USER: international-transfers-service
      POSTGRES_PASSWORD: TheSuperSecretPassword
      POSTGRES_DB: international-transfers-service

  exchange-rate-service:
    build_directory: .batect/exchange-rate-service-fake

  international-transfers-service:
    build_directory: .batect/international-transfers-service
    dependencies:
      - database
      - exchange-rate-service

  docker-push-env:
    build_directory: .batect/docker-push-env
    volumes:
      - local: .
        container: /code
        options: cached
      - local: /var/run/docker.sock
        container: /var/run/docker.sock
    working_directory: /code

tasks:
  build:
    description: Build the application.
    group: Build tasks
    run:
      container: java-build-env
      command: ./gradlew shadowJar

  unitTest:
    description: Run the unit tests.
    group: Test tasks
    run:
      container: java-build-env
      command: ./gradlew test

  continuousUnitTest:
    description: Run the unit tests and then re-run them when any code changes are detected.
    group: Test tasks
    run:
      container: java-build-env
      command: ./gradlew --continuous test

  integrationTest:
    description: Run the integration tests.
    group: Test tasks
    dependencies:
      - database
      - exchange-rate-service
    run:
      container: java-build-env
      command: ./gradlew integrationTest

  journeyTest:
    description: Run the journey tests.
    group: Test tasks
    prerequisites:
      - build
    dependencies:
      - international-transfers-service
    run:
      container: java-build-env
      command: ./gradlew journeyTest

  run:
    description: Run the application.
    group: Test tasks
    prerequisites:
      - build
    run:
      container: international-transfers-service
      ports:
        - local: 6001
          container: 6001

  pushImage:
    description: Build and push the production application image to Docker Hub.
    group: Publishing tasks
    prerequisites:
      - build
    run:
      container: docker-push-env
      command: ./.batect/buildAndPushImage.sh
      environment:
        DOCKER_USER: $DOCKER_USER
        DOCKER_PASSWORD: $DOCKER_PASSWORD

include:
  - type: git
    repo: https://github.com/batect/java-bundle.git
    ref: 0.1.0

```

这个yml中主要分3大部分：`containers`, `tasks` and `include`

